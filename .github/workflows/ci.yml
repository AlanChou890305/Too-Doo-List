name: CI

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  lint-and-check:
    name: Code Quality Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Check for common issues
        run: |
          echo "ğŸ” Checking for common issues..."

          # æª¢æŸ¥æ˜¯å¦æœ‰ console.log éºç•™
          if grep -r "console\.log" --include="*.js" --include="*.jsx" --include="*.ts" --include="*.tsx" App.js src/ | grep -v "node_modules" | grep -v "scripts"; then
            echo "âš ï¸ Warning: Found console.log statements (consider removing for production)"
          fi

          # æª¢æŸ¥ç‰ˆæœ¬è™Ÿæ˜¯å¦æ›´æ–°
          echo "ğŸ“¦ Current version: $(node -p "require('./package.json').version")"

          # æª¢æŸ¥æ˜¯å¦æœ‰ç¡¬ç·¨ç¢¼çš„ API keys
          if grep -r "api.*key\|secret\|password" --include="*.js" --include="*.jsx" App.js src/ -i | grep -v "node_modules" | grep -v "EXPO_PUBLIC"; then
            echo "âš ï¸ Warning: Potential hardcoded secrets found"
          fi

      - name: Verify build
        run: |
          echo "ğŸ”¨ Verifying web build..."
          npm run build

  dependency-check:
    name: Dependency Security Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"

      - name: Install dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --audit-level=moderate
        continue-on-error: true

      - name: Check for outdated packages
        run: |
          echo "ğŸ“¦ Checking for outdated packages..."
          npm outdated || true

  version-check:
    name: Version Consistency Check
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Check version consistency
        run: |
          PACKAGE_VERSION=$(node -p "require('./package.json').version")
          APP_CONFIG_VERSION=$(node -p "require('./app.config.js').default.extra.version || 'not found'")

          echo "ğŸ“¦ Package.json version: $PACKAGE_VERSION"
          echo "ğŸ“± App.config.js version: $APP_CONFIG_VERSION"

          if [ "$APP_CONFIG_VERSION" != "not found" ] && [ "$PACKAGE_VERSION" != "$APP_CONFIG_VERSION" ]; then
            echo "âŒ Version mismatch detected!"
            exit 1
          fi

          echo "âœ… Versions are consistent"
